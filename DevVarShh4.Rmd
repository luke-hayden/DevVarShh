---
title: "DevVarShh"
author: "Luke Hayden"
date: "July 30, 2016"
output:
  pdf_document: default
  html_document: default
---

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
library("ggplot2")
library("reshape2")
library("ade4") 
library("ecodist")
library("phytools")
library("dplyr")
library("tidyr")
library("Rmisc")

setwd("~/Documents/varpap")
ed <- read.csv("ed.csv")
setwd("~/Documents/varpap/new")

jaw <- "md"
```




```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

mxstg <- read.table(paste(jaw, "FVBDUHiCD1scores20.txt", sep=""))

mxstg$nid <- as.factor(paste(mxstg$Weight, mxstg$Clutch, sep=""))

mxstg <- subset(mxstg, mxstg$Strain != "CD1")
```

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

lf <- Sys.glob("predic*")

combdat <- data.frame(matrix(nrow=0,ncol=20))

for (i in lf){
  lht <- read.table(i)
  lht$sd <- substr(i,(nchar(i)-6), (nchar(i)-4))
  combdat <-rbind(combdat, lht)
}


ndat <- subset(combdat, combdat$sd == "001")
ndat05 <- subset(combdat, combdat$sd == "005")
ndat15 <- subset(combdat, combdat$sd == "015")

ndat$dev05 <- ndat05$dev
ndat$dev15 <- ndat15$dev


names(ndat)[names(ndat) == 'dev'] <- 'dev01'
ndat$ident <- seq(1, nrow(ndat))

ndat$nid <- as.factor(paste(ndat$Weight, ndat$Litter, sep=""))

mxstgp <- left_join(mxstg, ndat, by="nid")



write.csv(ndat, file="ndat.csv")

write.csv(mxstgp, file=paste(jaw, "dat.csv", sep=""))
```


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
mxstgp2 <- read.csv(paste(jaw,"dat2.csv", sep="")) %>%
filter(!(is.na(ident)))



mxstgp2 <- left_join(mxstgp2, ndat, by="ident")

write.csv(mxstgp2, file=paste(jaw, "datagood.csv", sep=""))

mxstgp2 <- read.csv( file=paste(jaw, "datagood.csv", sep=""))

#mmxstgp2 <- gather(mxstgp2, key="sdnum", value="NewMod", c(35,39,40))
#md

#mmxstgp2 <- gather(mxstgp2, key="sdnum", value="NewMod", c(38,42,43))
#mx

#ggplot(mmxstgp2, aes(x=Age, y=NewMod, colour=sdnum)) +  geom_point()+   theme_minimal()+   xlab("Old model cdpc")+  ylab("New model cdpc")

```

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

names(mxstgp2)[names(mxstgp2) == 'Strain.x'] <- 'Strain'

names(mxstgp2)[names(mxstgp2) == 'Weight.x'] <- 'Weight'

#md
#mxstgmelted <- gather(mxstgp2, key="variable", value="value", c(8,9,11,13))

#mx
#mxstgmelted <- gather(mxstgp2, key="variable", value="value", c(11,12,14,16))


mxstgmelted <- gather(mxstgp2, key="variable", value="value", c("shh_R2_spot","shh_M1_spot","cap_transition","shboob"))

mxstgmelted$variable[mxstgmelted$variable == "shh_R2_spot"] <- "R2 Shh expression"
mxstgmelted$variable[mxstgmelted$variable == "shh_M1_spot"] <- "M1 Shh expression"
mxstgmelted$variable[mxstgmelted$variable == "cap_transition"] <- "Cap transition"
mxstgmelted$variable[mxstgmelted$variable == "shboob"] <- "Anterior protrusion"

mxstg <- mxstgp2
```


#Logistic regression
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

#logistic regression
subsmxstg <- subset(mxstg, Strain!= "CD1")
subsmxstg$shh_R2_spot <- factor(subsmxstg$shh_R2_spot > 0)
subsmxstg$Strain <- factor(subsmxstg$Strain)
mxlogitR2 <- glm(shh_R2_spot ~ Weight + Strain, data = subsmxstg, family = "binomial")

subsmxstg$shh_M1_spot <- factor(subsmxstg$shh_M1_spot > 0)
mxlogitM1 <- glm(shh_M1_spot ~ Weight + Strain, data = subsmxstg, family = "binomial")
summary(mxlogitM1)

subsmxstg$cap_transition <- factor(subsmxstg$cap_transition > 0)
mxlogitCAP <- glm(cap_transition ~ Weight + Strain, data = subsmxstg, family = "binomial")
summary(mxlogitCAP)

mxlogitSHB <- glm(shboob ~ Weight + Strain, data = subsmxstg, family = "binomial")
summary(mxlogitSHB)

```

#Graphing



with calculated devtime
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
  

#mxstgmelted <- melt(mxstg, id.vars=c("ID", "Strain", "Age", "Weight", "Clutch", "shh_M2_spot", "M1_spot_split_LR", "Total_state", "stateord", "Symmetry", "groupwt", "mediantemps", "Date", "X", "nid"))
  
mxstgmelted$value[mxstgmelted$Strain == "FVB"] <- mxstgmelted$value[mxstgmelted$Strain == "FVB"] +0.05
mxstgmelted$value[mxstgmelted$Strain == "DUHi"] <- mxstgmelted$value[mxstgmelted$Strain == "DUHi"] -0.05
mxstgmelted$variable <- as.character(mxstgmelted$variable)

mxstgmelted$variable[mxstgmelted$variable == "shh_R2_spot"] <- "R2 Shh expression"
mxstgmelted$variable[mxstgmelted$variable == "shh_M1_spot"] <- "M1 Shh expression"
mxstgmelted$variable[mxstgmelted$variable == "cap_transition"] <- "Cap transition"
mxstgmelted$variable[mxstgmelted$variable == "shboob"] <- "Anterior protrusion"
mxstgmelted$variable <- factor(mxstgmelted$variable, levels= c("R2 Shh expression","M1 Shh expression", "Cap transition", "Anterior protrusion") )


mmxstgmelted <- gather(mxstgmelted, key="agemeasure", value="oldness", c("Age","Weight", "dev01", "dev05", "dev15"))


(p <- ggplot(mmxstgmelted, aes(x=oldness,y=value,color=Strain,shape=Strain)) +
  geom_point(size=1.5) + 
  facet_grid(variable~agemeasure, scales= "free") +  
  scale_y_continuous(breaks=c(0,1,2)) + 
  scale_colour_manual(values=c("red3",  "cornflowerblue")) +
  xlab("Computed developmental age (cdpc)")+
  ylab("") +
  theme_bw()+ 
  ggtitle(paste(jaw, "character progression"))
)

ggsave(plot=p,height=10, width=14, file=paste(jaw,"charprog.pdf" ,sep="") )


```

#Total state, one panel by strain

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


m2 <- data.frame(id =mxstg$ID, totstat=mxstg$Total_state,Strain=mxstg$Strain, stateord =mxstg$stateord, weight=mxstg$Weight,Age=mxstg$Age, dev01=mxstg$dev01, dev05= mxstg$dev05, dev15=mxstg$dev15)
d <- subset(m2, m2$Strain =="DUHi" )
y=levels(m2$stateord)
f <- subset(m2, m2$Strain =="FVB")

i <- d$stateord %in% f$stateord
d2 <- subset(d, !i)


i <- f$stateord %in% d$stateord
f2 <- subset(f, !i)

m3 <- data.frame(
  y=levels(m2$stateord), 
  din =y %in% d2$stateord,
  fin=y %in% f2$stateord,
  end=max(m2$cdpc),
  start=min(m2$cdpc)) 


m4 <- melt(m3, id.vars=c("y", "end", "start"))
m4$Strain <- "DUHi"
m4$Strain[m4$variable == "fin"] <- "FVB"



m5 <- gather(mxstg, key="agemeasure", value="oldness", c("Age","Weight", "dev01", "dev05", "dev15"))

(p <- ggplot(m5, aes(x=oldness,y=stateord,color=Strain)) +
  geom_point(size=1) + 
  facet_grid(Strain~agemeasure, scales="free") + 
  scale_colour_manual(values=c("red3",  "red3", "cornflowerblue","cornflowerblue"))   +
  xlab("Computed Embryo Age (cdpc)") +
  ylab("Embryo overall state") +
  geom_segment(inherit.aes=FALSE, data=m4, aes(x=start, xend=end, y=y, yend=y, alpha=value, colour=variable, size=10)) +
  scale_alpha_manual(values=c(0,0.3)) +
  theme_bw()+
  theme(legend.position = "none")
)


ggsave(plot=p,height=7, width=24, file=paste(jaw,"allstate.pdf" ,sep="") )




```


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

ggplot(m2, aes(x=cdpc,y=stateord,color=Strain)) +
  geom_point(size=1) + 
  facet_wrap(~ Strain,ncol=1) + 
  scale_colour_manual(values=c("red3",  "red3", "cornflowerblue","cornflowerblue"))   +
  xlab("Computed Embryo Age (cdpc)") +
  ylab("Embryo overall state") +
  geom_segment(inherit.aes=FALSE, data=m4, aes(x=start, xend=end, y=y, yend=y, alpha=value, colour=variable, size=10)) +
  scale_alpha_manual(values=c(0,0.3)) +
  theme_bw()+
  theme(legend.position = "none")




```




#Weight and dev state dist matrices for DUHI
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

stgmin <- select(mxstg, c("ID","Strain", "shh_R2_spot", "shh_M1_spot", "cap_transition", "shboob", "Weight", "dev01", "dev05", "dev15"))

agethresh <- c(10,0.25,0.25,0.25)
plotlist <- list()
plotlistbox <- list()


for (i in 1:4){
  

stgmin$agemeas <- stgmin[,6+i]
varname <- colnames(stgmin)[6+i]
  
mxsd <-subset(stgmin, Strain=="DUHi")

agedmat <- abs(as.vector(outer(mxsd$agemeas, mxsd$agemeas, "-")))
r2dmat <- abs(as.vector(outer(mxsd$shh_R2_spot, mxsd$shh_R2_spot, "-")))
m1dmat <- abs(as.vector(outer(mxsd$shh_M1_spot, mxsd$shh_M1_spot, "-")))
capdmat <- abs(as.vector(outer(mxsd$cap_transition, mxsd$cap_transition, "-")))
shbdmat <- abs(as.vector(outer(mxsd$shboob, mxsd$shboob, "-")))

pairmeanage <- as.vector(outer(mxsd$agemeas ,mxsd$agemeas, "+"))/2

#isclose <- agedmat < 0.25
isclose <- agedmat < agethresh[i]
alldmat<- r2dmat + m1dmat +capdmat + shbdmat

dutimevar <- subset(data.frame(agedmat, r2dmat, m1dmat, capdmat, shbdmat, alldmat, pairmeanage, Strain="DUHi"), isclose)


mxsd <- subset(stgmin, Strain=="FVB")

agedmat <- abs(as.vector(outer(mxsd$agemeas, mxsd$agemeas, "-")))
r2dmat <- abs(as.vector(outer(mxsd$shh_R2_spot, mxsd$shh_R2_spot, "-")))
m1dmat <- abs(as.vector(outer(mxsd$shh_M1_spot, mxsd$shh_M1_spot, "-")))
capdmat <- abs(as.vector(outer(mxsd$cap_transition, mxsd$cap_transition, "-")))
shbdmat <- abs(as.vector(outer(mxsd$shboob, mxsd$shboob, "-")))

pairmeanage <- as.vector(outer(mxsd$agemeas ,mxsd$agemeas, "+"))/2

#isclose <- agedmat < 0.25
isclose <- agedmat <agethresh[i]
alldmat<- r2dmat + m1dmat +capdmat + shbdmat

fvtimevar <- subset(data.frame(agedmat, r2dmat, m1dmat, capdmat, shbdmat, alldmat, pairmeanage, Strain= "FVB"), isclose)
timevar <- rbind(dutimevar, fvtimevar)

(p<-ggplot(data=timevar, aes(x=pairmeanage, y=alldmat, colour=Strain)) +
  geom_point(size=2, alpha =0.05) + 
  stat_smooth(method=loess, size=1.5) +
#  ylim(-0.5,2)+ 
  scale_colour_manual(values=c("red3", "cornflowerblue")) +
  ylab("Mean Developmental State Difference") +
  xlab("Computed Embryo Age (cdpc)") + 
#  coord_fixed(ratio=40)+
  theme_bw()+
  ggtitle(label=paste("Time series, age measure:", varname), 
                subtitle=paste("threshold:" ,agethresh[i])))
plotlist[[i]] <- p



wiltest <- wilcox.test(timevar$alldmat[timevar$Strain == "DUHi"],timevar$alldmat[timevar$Strain == "FVB"] )
wilpval <- round(wiltest$p.value, 6)

(p<-ggplot(data=timevar, aes(y=alldmat,x=Strain, fill=Strain)) +
  geom_boxplot(outlier.shape = NA) + 
#  ylim(-0.5,2)+ 
  scale_fill_manual(values=c("red3", "cornflowerblue")) +
  ylab("Mean Developmental State Difference") +
  xlab("Strain") + 
  theme_bw()+
  ggtitle(label=paste("Overall variability, age measure:", varname), 
                subtitle=paste("threshold:" ,agethresh[i], "wilcoxon test pvalue=", wilpval)))

plotlistbox[[i]] <- p

}



pdf(paste(jaw,"timevar.pdf" ,sep=""),height=18, width=7)
multiplot(plotlist=plotlist, cols=1)
dev.off()


pdf(paste(jaw,"allvar.pdf" ,sep=""),height=10, width=10)
multiplot(plotlist=plotlistbox, cols=2)
dev.off()

```






#Plotting state difference versus weight difference
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

########
plot(dvwtdmat, dvstatedmat, lty=0, pch="I", cex=4,col=adjustcolor("forest green", alpha=0.05), xlab="Age difference(mg)", ylab="Developmental state difference", main="DUHi")
dev.copy(svg,'DUdevdistVweightdist.svg')
dev.off()
dev.copy(pdf,'DUdevdistVweightdist.pdf')
dev.off()

dev.copy(png,'DUdevdistVweightdistg.png')
dev.off()


plot(fvwtdmat, fvstatedmat, lty=0, col=adjustcolor("cornflowerblue", alpha=0.05), pch="I", cex=4, xlab="Age difference(mg)", ylab="Developmental state difference", main="FVB")
dev.copy(svg,'FVdevdistVweightdist.svg')
dev.off()
dev.copy(pdf,'FVdevdistVweightdist.pdf')
dev.off()
dev.copy(png,'FVdevdistVweightdist.png')
dev.off()



plot(fvwtdmat, fvstatedmat, lty=0, col=adjustcolor("blue", alpha=0.005), pch=15, cex=4, xlab="Age difference(mg)", ylab="Developmental state difference", xlim =c(0,400))
lines(dvwtdmat, dvstatedmat, type="p", pch=15, cex=4,col=adjustcolor("red", alpha=0.006))
lines(fvwtdmat, fvstatedmat, type="p", pch=15, cex=4,col=adjustcolor("blue", alpha=0.005))
#lines(dvwtdmat, dvstatedmat, type="p", pch=15, cex=4,col=adjustcolor("red3", alpha=0.01))
#lines(fvwtdmat, fvstatedmat, type="p", pch=15, cex=4,col=adjustcolor("cornflower blue", alpha=0.005))

legend(320,1.5,  c("DUHi","FVB"), lty=c(1,1), lwd=c(2,2),col=c("red","cornflowerblue"))
dev.copy(svg,'bothdevdistVweightdist.svg')
dev.off()
dev.copy(pdf,'bothdevdistVweightdist.pdf')
dev.off()

```


#Mantel
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

mxsd <- subset(mxstg[,c(2,3,6,9,10,12,14)], Strain=="DUHi")

agedmat <- dist(mxsd$mediantemps)
r2dmat <- dist(mxsd$shh_R2_spot)
m1dmat <- dist(mxsd$shh_M1_spot)
capdmat <- dist(mxsd$cap_transition)
shbdmat <- dist(mxsd$shboob)


dualldmat<- r2dmat + m1dmat +capdmat + shbdmat
duagedmat<- agedmat

mxsd <- subset(mxstg[,c(2,3,6,9,10,12,14)], Strain=="FVB")

agedmat <- dist(mxsd$mediantemps)
r2dmat <- dist(mxsd$shh_R2_spot)
m1dmat <- dist(mxsd$shh_M1_spot)
capdmat <- dist(mxsd$cap_transition)
shbdmat <- dist(mxsd$shboob)


fvalldmat<- r2dmat + m1dmat +capdmat + shbdmat
fvagedmat<- agedmat


mxfmant <- mantel(formula = fvagedmat ~ fvalldmat, data = sys.parent(), nperm = 1000,
       mrank = FALSE, nboot = 500, pboot = 0.9, cboot = 0.95)
summary(mxfmant)
mxfmant
mxdmant <- mantel(formula = duagedmat ~ dualldmat, data = sys.parent(), nperm = 1000,
                mrank = FALSE, nboot = 500, pboot = 0.9, cboot = 0.95)
summary(mxdmant)
mxdmant

dpmant <- multi.mantel(duagedmat , dualldmat, nperm=1000)
dpmant
fpmant <- multi.mantel(fvagedmat , fvalldmat, nperm=1000)
fpmant
```

Plotting residuals from the Mantel

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

plot(dpmant$residuals, col="red3", type="o", pch=16,lty=0,size=4, alpha=0.1 ,ylab="Residuals", main="DUHi",ylim=c(0,2))


points(fpmant$residuals, col="cornflowerblue", type="o", pch=16,lty=0,size=4, alpha=0.2 ,ylab="Residuals", main="FVB", ylim=c(0,2))
```

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


dreds <- c(dpmant$residuals)

freds <- c(fpmant$residuals)
```

 

#Wilcoxon rank-sum test on the residuals
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
wilcox.test(dreds[dreds >0], freds[freds >0])
wilcox.test(abs(freds), abs(dreds))

```

#Boxplot of total developmental variation 
Takes the positive residuals from each Mantel test of the developmental state distance matrix vs the embryo weight distance matrix

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
ddu <- data.frame(c("DUHi"), dreds)
colnames(ddu) <- c("Strain", "resid")
ffu <- data.frame(c("FVB"), freds)
colnames(ffu) <- c("Strain", "resid")



resids <- rbind(ddu,ffu)


ggplot(data=resids, aes(x=Strain, y= resid, colour=Strain))+geom_point(alpha=0.01)

p=ggplot(data=resids, aes(x=Strain, y= resid, colour=Strain))+geom_point(alpha=0.01)+
  geom_violin()
ggsave(plot=p, filename="violin.pdf")

p=ggplot(data=resids, aes(x=Strain, y= resid, colour=Strain))+geom_point(alpha=0.01)+
  geom_boxplot()

ggsave(plot=p, filename="box.pdf")

ggplot(data=resids, aes(fill=Strain, x=resid)) +geom_density()

qplot(Strain, resid, data = resids, geom = "boxplot",color=Strain) + scale_colour_manual(values=c("red3", "cornflowerblue"))+ylab("Developmental Variation")
dev.copy(svg,'devvarboxplotplot.svg')
dev.off()
dev.copy(pdf,'devvarboxplotplot.pdf')
dev.off()

```


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

dulm <-lm(mxstg$Age[mxstg$Strain == "DUHi"] ~ mxstg$mediantemps[mxstg$Strain == "DUHi"])
fvlm <- lm(mxstg$Age[mxstg$Strain == "FVB"] ~ mxstg$mediantemps[mxstg$Strain == "FVB"])



a=ggplot(mxstgmelted, aes(x=Weight, y=mediantemps, colour=Strain)) +
  geom_point()+
  stat_smooth(method="lm")+
  facet_wrap(~Strain, ncol=1)+
  scale_colour_manual(values=c("red3", "cornflowerblue"))+
  ylab("Computed developmental age (cdpc)")+
  xlab("Weight (mg)") +
  theme_bw()+
  geom_text(inherit.aes=FALSE, 
            data=data.frame(num= c(paste("n=", sum(mxstg$Strain == "DUHi")), paste("n=",sum(mxstg$Strain == "FVB"))), 
                                   Strain= c("DUHi", "FVB"), x=c(100,100), y=c(16,16)), aes(x=x,y=y,label=num) )                                 

ggsave(plot=a, file="dvflm.pdf")

```

